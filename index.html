<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>SimplyDoors Measure App</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
    /* --- CORE STYLING --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        background-color: #f0f2f5; 
        margin: 0; 
        padding: 15px; 
        color: #333;
        padding-bottom: 140px; /* Space for floating buttons */
    }
    .container { 
        max-width: 100%; 
        margin: 0 auto; 
        background: white; 
        border-radius: 12px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        overflow: hidden;
    }
    .header {
        background-color: #2c3e50;
        color: white;
        padding: 20px;
        text-align: center;
        position: relative;
    }
    /* Smooth fade for save indicator */
    .save-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 11px;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        background: rgba(255,255,255,0.2);
        padding: 4px 8px;
        border-radius: 4px;
        pointer-events: none;
    }
    
    h1 { margin: 0; font-size: 20px; letter-spacing: -0.5px; }
    .section { padding: 20px; border-bottom: 1px solid #eee; }
    h2 { font-size: 16px; text-transform: uppercase; color: #666; margin-top: 0; border-bottom: 2px solid #2c3e50; display: inline-block; padding-bottom: 5px;}
    
    /* INPUTS - optimized for touch */
    label { display: block; margin-top: 12px; font-weight: 600; font-size: 14px; color: #444; }
    input[type="text"], input[type="date"], input[type="number"], select, textarea { 
        width: 100%; 
        padding: 12px; 
        margin-top: 5px; 
        border: 1px solid #ccc; 
        border-radius: 8px; 
        font-size: 16px; /* Prevents iOS auto-zoom */
        background: #fafafa;
        appearance: none; /* Removes default iOS styling */
    }
    textarea { resize: vertical; min-height: 70px; }
    
    /* LABOR CHECKBOXES */
    .labor-options {
        background-color: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        margin-top: 5px;
    }
    .labor-options label {
        font-weight: normal;
        margin-top: 8px;
        display: flex;
        align-items: center;
    }
    .labor-options input[type="checkbox"] {
        width: 20px; 
        height: 20px;
        margin-right: 12px;
        margin-top: 0;
    }

    .row { display: flex; gap: 12px; }
    .col { flex: 1; }

    /* PHOTO GRID - FIXED HEIGHT FOR STABILITY */
    .photo-label { margin-top: 18px; margin-bottom: 8px; display: block; }
    .photo-grid { display: flex; gap: 8px; margin-bottom: 5px; }
    .photo-box {
        flex: 1; 
        height: 90px;
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        background-color: #f7fafc;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    .photo-box.has-image { border: 2px solid #28a745; background-color: #fff; }
    .photo-box input[type="file"] { display: none; }
    .photo-placeholder { text-align: center; font-size: 10px; color: #718096; pointer-events: none; line-height: 1.3; }
    .photo-preview { width: 100%; height: 100%; object-fit: cover; display: none; }

    /* BUTTONS */
    .btn-group { 
        padding: 12px; 
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(5px);
        position: fixed; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        border-top: 1px solid #ddd; 
        box-shadow: 0 -4px 20px rgba(0,0,0,0.08); 
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        z-index: 999;
    }
    button { 
        flex: 1;
        padding: 14px; 
        border: none; 
        border-radius: 10px; 
        font-size: 15px; 
        font-weight: 700; 
        cursor: pointer; 
        color: white;
        text-align: center;
        min-width: 100px;
        transition: transform 0.1s;
    }
    button:active { transform: scale(0.98); }
    .btn-add { background-color: #28a745; } 
    .btn-dup { background-color: #6f42c1; } 
    .btn-print { background-color: #007bff; } 
    .btn-reset { background-color: #dc3545; flex-basis: 100%; margin-top: 0px; opacity: 0.9;}

    /* WINDOW CARD */
    .window-card {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-left: 6px solid #28a745;
        border-radius: 10px;
        padding: 18px;
        margin-bottom: 25px;
        position: relative;
        page-break-inside: avoid; /* Essential for PDF */
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .window-number {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #edf2f7;
        color: #4a5568;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 800;
    }

    .highlight { animation: flash 0.8s; }
    @keyframes flash { 0% { background-color: #e2e6ea; } 100% { background-color: #fff; } }

    /* CLEAN UP FOR PDF GENERATION */
    .printing-mode .btn-group { display: none !important; }
    .printing-mode .container { box-shadow: none; border: none; }
    .printing-mode .window-card { box-shadow: none; border: 1px solid #ccc; }
    /* Hide empty photo placeholders when printing to make it look professional */
    .printing-mode .photo-box:not(.has-image) { display: none; } 
    .printing-mode .photo-grid { justify-content: flex-start; }
    .printing-mode .photo-box { border: 1px solid #ddd; flex: 0 0 32%; } /* Fixed width for print */
</style>
</head>
<body>

<div class="container" id="pdf-content">
    <div class="header">
        <h1>SimplyDoors Measure</h1>
        <div class="save-indicator" id="saveMsg">Saved</div>
    </div>
    
    <datalist id="jamb-sizes">
        <option value="4 9/16 (2x4)">
        <option value="6 9/16 (2x6)">
        <option value="5 1/4">
        <option value="Drywall Return">
    </datalist>

    <datalist id="trim-types">
        <option value="1x6 PFJ">
        <option value="1x4 PFJ">
        <option value="1x4 Cedar">
        <option value="1x6 Cedar">
        <option value="1x4 Hardie">
        <option value="1x6 Hardie">
        <option value="1x4 Vinyl">
        <option value="1x6 Vinyl">
    </datalist>

    <div class="section">
        <h2>Job Details</h2>
        <label>Customer Name:</label>
        <input type="text" class="save-me" placeholder="Last Name, First Name" name="customer_name" id="cust_name">
        
        <div class="row">
            <div class="col">
                <label>PO #:</label>
                <input type="text" class="save-me" name="po_number" id="po_num">
            </div>
            <div class="col">
                <label>Date:</label>
                <input type="date" class="save-me" id="dateField" name="measure_date">
            </div>
        </div>
        
        <label>Measure Tech:</label>
        <select class="save-me" id="techSelect" name="measure_tech">
            <option value="" disabled selected>Select Tech...</option>
            <option value="Adem Atis">Adem Atis</option>
            <option value="John Suttin">John Suttin</option>
            <option value="Steven Chandler">Steven Chandler</option>
            <option value="Isaiah Stratton">Isaiah Stratton</option>
            <option value="Paz Galambos">Paz Galambos</option>
            <option value="Alan Lloyd">Alan Lloyd</option>
        </select>
    </div>

    <div id="windows-container" class="section">
        </div>
</div>

<div class="btn-group">
    <button type="button" class="btn-add" onclick="addWindow()">+ New</button>
    <button type="button" class="btn-dup" onclick="duplicateLast()">+ Copy</button>
    <button type="button" class="btn-print" id="pdfBtn" onclick="downloadPDF()">Save PDF</button>
    <button type="button" class="btn-reset" onclick="startNewJob()">Start New Job</button>
</div>

<script>
    const container = document.getElementById('windows-container');
    const saveMsg = document.getElementById('saveMsg');
    let windowCount = 0;
    // Debounce Timer (Wait 500ms after typing to save)
    let saveTimeout;

    // --- APP INIT ---
    window.onload = function() { loadData(); };

    // --- ADD WINDOW FUNCTION ---
    function addWindow(data = null) {
        windowCount++;
        const vals = data || {
            loc: '', floor: '1st', fins: '', w: '', h: '', jamb: '', trim: '', 
            l_sw: false, l_gt: false, l_sr: false, l_rf: false, notes: ''
        };

        const html = `
        <div class="window-card" id="card_${windowCount}">
            <div class="window-number">#${windowCount}</div>
            <label>Location Name:</label>
            <input type="text" class="loc-name save-me-dynamic" placeholder="e.g. Master Bed" value="${vals.loc}">
            <div class="row">
                <div class="col"><label>Floor:</label><select class="save-me-dynamic" onchange="triggerSave()">
                    <option ${vals.floor === '1st' ? 'selected' : ''}>1st</option>
                    <option ${vals.floor === '2nd' ? 'selected' : ''}>2nd</option>
                    <option ${vals.floor === '3rd' ? 'selected' : ''}>3rd</option>
                    <option ${vals.floor === 'Bsmt' ? 'selected' : ''}>Bsmt</option>
                </select></div>
                <div class="col"><label>Fins?</label><select class="save-me-dynamic" onchange="triggerSave()">
                    <option value="" ${vals.fins === '' ? 'selected' : ''}></option>
                    <option ${vals.fins === 'Yes' ? 'selected' : ''}>Yes</option>
                    <option ${vals.fins === 'No' ? 'selected' : ''}>No</option>
                </select></div>
            </div>
            <div class="row">
                <div class="col"><label>Width:</label><input type="number" class="save-me-dynamic" inputmode="decimal" placeholder="0.0" value="${vals.w}"></div>
                <div class="col"><label>Height:</label><input type="number" class="save-me-dynamic" inputmode="decimal" placeholder="0.0" value="${vals.h}"></div>
            </div>
            <label>Jamb Depth:</label><input type="text" class="save-me-dynamic" list="jamb-sizes" placeholder="Select or Type..." value="${vals.jamb}">
            <label>Ext. Trim:</label><input type="text" class="save-me-dynamic" list="trim-types" placeholder="Select or Type..." value="${vals.trim}">
            <label>Window Labor:</label>
            <div class="labor-options">
                <label><input type="checkbox" class="save-me-dynamic" ${vals.l_sw ? 'checked' : ''}> Cut back sheet rock/wood</label>
                <label><input type="checkbox" class="save-me-dynamic" ${vals.l_gt ? 'checked' : ''}> Cut back Granit/Tile</label>
                <label><input type="checkbox" class="save-me-dynamic" ${vals.l_sr ? 'checked' : ''}> Stucco Removal</label>
                <label><input type="checkbox" class="save-me-dynamic" ${vals.l_rf ? 'checked' : ''}> Re-Trim/Flashing</label>
            </div>
            <label>Notes:</label><textarea class="save-me-dynamic">${vals.notes}</textarea>
            
            <label class="photo-label">Photos (Tap box to add):</label>
            <div class="photo-grid">
                <div class="photo-box" onclick="triggerFile(this)"><div class="photo-placeholder">ðŸ“·<br>Photo 1</div><img class="photo-preview"><input type="file" accept="image/*" capture="environment" onchange="loadFile(this)"></div>
                <div class="photo-box" onclick="triggerFile(this)"><div class="photo-placeholder">ðŸ“·<br>Photo 2</div><img class="photo-preview"><input type="file" accept="image/*" capture="environment" onchange="loadFile(this)"></div>
                <div class="photo-box" onclick="triggerFile(this)"><div class="photo-placeholder">ðŸ“·<br>Photo 3</div><img class="photo-preview"><input type="file" accept="image/*" capture="environment" onchange="loadFile(this)"></div>
            </div>
        </div>`;
        
        container.insertAdjacentHTML('beforeend', html);
        
        // Attach Listeners
        const newCard = container.lastElementChild;
        newCard.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('input', triggerSave);
            input.addEventListener('change', triggerSave);
        });

        if (!data) { 
            setTimeout(() => newCard.scrollIntoView({ behavior: "smooth", block: "center" }), 150); 
            triggerSave(); 
        }
    }

    // --- DUPLICATION LOGIC ---
    function duplicateLast() {
        const allCards = document.querySelectorAll('.window-card');
        if (allCards.length === 0) { addWindow(); return; }
        const lastCard = allCards[allCards.length - 1];
        const inputs = lastCard.querySelectorAll('.save-me-dynamic');
        const data = {
            loc: '', floor: inputs[1].value, fins: inputs[2].value, w: '', h: '', jamb: inputs[5].value, trim: inputs[6].value,
            l_sw: inputs[7].checked, l_gt: inputs[8].checked, l_sr: inputs[9].checked, l_rf: inputs[10].checked, notes: ''
        };
        addWindow(data);
        // Focus new name
        const newCards = document.querySelectorAll('.window-card');
        const target = newCards[newCards.length-1].querySelector('.loc-name');
        setTimeout(() => target.focus(), 200);
    }

    // --- OPTIMIZED SAVE SYSTEM (DEBOUNCED) ---
    function triggerSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(performSave, 500); // Wait 500ms after stopping typing
    }

    function performSave() {
        const globalData = { cust: document.getElementById('cust_name').value, po: document.getElementById('po_num').value, date: document.getElementById('dateField').value, tech: document.getElementById('techSelect').value };
        const windowData = [];
        document.querySelectorAll('.window-card').forEach(card => {
            const inputs = card.querySelectorAll('.save-me-dynamic');
            windowData.push({
                loc: inputs[0].value, floor: inputs[1].value, fins: inputs[2].value, w: inputs[3].value, h: inputs[4].value, jamb: inputs[5].value, trim: inputs[6].value,
                l_sw: inputs[7].checked, l_gt: inputs[8].checked, l_sr: inputs[9].checked, l_rf: inputs[10].checked, notes: inputs[11].value
            });
        });
        localStorage.setItem('simplyDoorsMeasureData', JSON.stringify({ global: globalData, windows: windowData }));
        
        // UI Feedback
        saveMsg.style.opacity = '1'; 
        setTimeout(() => saveMsg.style.opacity = '0', 1500);
    }

    function loadData() {
        const savedJSON = localStorage.getItem('simplyDoorsMeasureData');
        if (!savedJSON) { document.getElementById('dateField').valueAsDate = new Date(); addWindow(); return; }
        
        try {
            const data = JSON.parse(savedJSON);
            document.getElementById('cust_name').value = data.global.cust || '';
            document.getElementById('po_num').value = data.global.po || '';
            document.getElementById('dateField').value = data.global.date || '';
            document.getElementById('techSelect').value = data.global.tech || '';
            
            container.innerHTML = ''; windowCount = 0;
            if (data.windows.length > 0) data.windows.forEach(winData => addWindow(winData)); 
            else addWindow();
        } catch (e) {
            console.error("Save file corrupted");
            addWindow();
        }
    }

    // --- PDF GENERATION ---
    function downloadPDF() {
        // 1. Prepare UI
        document.body.classList.add('printing-mode'); // Hides buttons, optimizes look
        
        // 2. Force Textarea values into HTML for PDF engine to see them
        document.querySelectorAll('textarea, input').forEach(el => {
            if(el.type !== 'checkbox' && el.type !== 'file') el.setAttribute('value', el.value);
            if(el.tagName === 'TEXTAREA') el.innerHTML = el.value;
            if(el.type === 'checkbox' && el.checked) el.setAttribute('checked', 'checked');
        });

        let name = document.getElementById('cust_name').value.trim();
        if(!name) name = "Measure_Sheet";
        name = "SimplyDoors_" + name.replace(/[^a-z0-9]/gi, '_');

        const btn = document.getElementById('pdfBtn');
        const originalText = btn.innerText;
        btn.innerText = "Generating...";
        
        const element = document.getElementById('pdf-content');
        const opt = {
            margin:       [5, 5, 5, 5],
            filename:     name + '.pdf',
            image:        { type: 'jpeg', quality: 0.90 },
            html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(function(){
            btn.innerText = originalText;
            document.body.classList.remove('printing-mode'); // Restore UI
        }).catch(function(err) {
            alert("Error generating PDF. Please try refreshing.");
            document.body.classList.remove('printing-mode');
        });
    }

    function startNewJob() {
        if(confirm("âš ï¸ Start New Job?\n\nThis will ERASE all current data to start fresh.")) {
            localStorage.removeItem('simplyDoorsMeasureData'); 
            location.reload();
        }
    }

    // Global Listeners
    document.querySelectorAll('.save-me').forEach(el => {
        el.addEventListener('input', triggerSave);
    });

    // --- PHOTOS ---
    function triggerFile(box) { const input = box.querySelector('input[type="file"]'); if (input) input.click(); }
    
    function loadFile(input) { 
        const file = input.files[0]; 
        if (file) { 
            // Simple validation
            if(file.size > 5000000) { alert("Photo is too large. Please use a smaller photo."); return; }
            
            const box = input.parentElement; 
            const img = box.querySelector('.photo-preview'); 
            const placeholder = box.querySelector('.photo-placeholder'); 
            
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                img.src = e.target.result; 
                img.style.display = 'block'; 
                placeholder.style.display = 'none'; 
                box.classList.add('has-image'); 
            }; 
            reader.readAsDataURL(file); 
        }
    }
</script>

</body>
</html>