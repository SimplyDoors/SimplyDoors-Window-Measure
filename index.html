<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="SimplyDoors">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>SimplyDoors Window Measure</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
    /* --- CORE STYLING --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        background-color: #f4f7f6; 
        margin: 0; 
        padding: 15px; 
        color: #333;
        padding-bottom: 180px; /* Space for floating buttons + Safe Area */
    }
    .container { 
        max-width: 800px; 
        margin: 0 auto; 
        background: white; 
        border-radius: 16px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        overflow: hidden;
    }
    .header {
        background-color: #2c3e50;
        color: white;
        padding: 25px 20px;
        text-align: center;
        position: relative;
    }
    
    /* Status Indicators */
    .save-indicator {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 11px;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        background: rgba(40, 167, 69, 0.9);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        pointer-events: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 10;
    }
    
    h1 { margin: 0; font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
    .section { padding: 20px; border-bottom: 1px solid #f0f0f0; }
    h2 { font-size: 14px; text-transform: uppercase; color: #888; margin-top: 0; border-bottom: 2px solid #2c3e50; display: inline-block; padding-bottom: 4px; letter-spacing: 0.5px;}
    
    /* INPUTS - Touch Optimized */
    label { display: block; margin-top: 15px; font-weight: 600; font-size: 14px; color: #444; }
    input[type="text"], input[type="date"], input[type="number"], select, textarea { 
        width: 100%; 
        padding: 14px; 
        margin-top: 6px; 
        border: 1px solid #dcdcdc; 
        border-radius: 10px; 
        font-size: 16px; /* Prevents iOS zoom */
        background: #fff;
        appearance: none; 
        transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus { border-color: #007bff; outline: none; background: #f8fbff; }
    textarea { resize: vertical; min-height: 80px; }
    
    /* LABOR CHECKBOXES - Fat Finger Friendly */
    .labor-options {
        background-color: #f9fafb;
        padding: 15px;
        border-radius: 12px;
        border: 1px solid #edf2f7;
        margin-top: 8px;
    }
    .labor-options label {
        font-weight: 500;
        margin-top: 12px;
        display: flex;
        align-items: center;
        padding: 5px 0; 
        cursor: pointer;
    }
    .labor-options input[type="checkbox"] {
        width: 24px; 
        height: 24px;
        margin-right: 12px;
        margin-top: 0;
        accent-color: #2c3e50;
        cursor: pointer;
    }

    .row { display: flex; gap: 12px; }
    .col { flex: 1; }

    /* PHOTO GRID */
    .photo-label { margin-top: 20px; margin-bottom: 10px; display: block; }
    .photo-grid { display: flex; gap: 10px; margin-bottom: 5px; }
    .photo-box {
        flex: 1; 
        height: 100px;
        border: 2px dashed #cbd5e0;
        border-radius: 10px;
        background-color: #f7fafc;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: background-color 0.2s;
    }
    .photo-box:active { background-color: #e2e8f0; }
    .photo-box.has-image { border: 2px solid #28a745; background-color: #fff; }
    .photo-box input[type="file"] { display: none; }
    .photo-placeholder { text-align: center; font-size: 11px; color: #718096; pointer-events: none; line-height: 1.4; font-weight: 500; }
    .photo-preview { width: 100%; height: 100%; object-fit: cover; display: none; }
    .photo-spinner { display: none; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* BUTTONS - Sticky Footer with Safe Area */
    .btn-group { 
        padding: 15px; 
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        position: fixed; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        border-top: 1px solid #e0e0e0; 
        box-shadow: 0 -4px 20px rgba(0,0,0,0.1); 
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        z-index: 999;
        padding-bottom: calc(15px + env(safe-area-inset-bottom));
    }
    button { 
        flex: 1;
        padding: 16px; 
        border: none; 
        border-radius: 12px; 
        font-size: 15px; 
        font-weight: 700; 
        cursor: pointer; 
        color: white;
        text-align: center;
        min-width: 100px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        -webkit-appearance: none;
    }
    button:active { transform: scale(0.96); opacity: 0.9; }
    .btn-add { background-color: #28a745; } 
    .btn-dup { background-color: #6f42c1; } 
    .btn-print { background-color: #007bff; } 
    .btn-reset { background-color: #dc3545; flex-basis: 100%; margin-top: 0px; opacity: 0.8; font-size: 13px; padding: 12px;}

    /* WINDOW CARD */
    .window-card {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-left: 6px solid #28a745;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        position: relative;
        page-break-inside: avoid; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.03);
    }
    .window-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .window-number {
        background: #2c3e50;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 700;
    }
    .btn-delete {
        background: #fee2e2;
        color: #c53030;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        font-weight: bold;
        font-size: 18px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .highlight { animation: flash 0.8s; }
    @keyframes flash { 0% { background-color: #e2e6ea; } 100% { background-color: #fff; } }

    /* CLEAN UP FOR PDF GENERATION */
    .printing-mode .btn-group { display: none !important; }
    .printing-mode .container { box-shadow: none; border: none; width: 100%; max-width: 100%; }
    .printing-mode .window-card { box-shadow: none; border: 1px solid #ccc; page-break-inside: avoid; margin-bottom: 15px; }
    .printing-mode .btn-delete { display: none; }
    .printing-mode .photo-box:not(.has-image) { display: none; } 
    .printing-mode .photo-grid { justify-content: flex-start; }
    .printing-mode .photo-box { border: 1px solid #ddd; flex: 0 0 31%; height: 140px; }
    .printing-mode body { background: white; padding: 0; }
</style>
</head>
<body>

<div class="container" id="pdf-content">
    <div class="header">
        <h1>SimplyDoors Window Measure</h1>
        <div class="save-indicator" id="saveMsg">Saved</div>
    </div>
    
    <datalist id="jamb-sizes">
        <option value="4 9/16">
        <option value="6 9/16">
        <option value="5 1/4">
        <option value="3 1/4">
        <option value="Drywall Return">
    </datalist>

    <datalist id="trim-types">
        <option value="1x6 PFJ">
        <option value="1x4 PFJ">
        <option value="1x4 Cedar">
        <option value="1x6 Cedar">
        <option value="1x4 Hardie">
        <option value="1x6 Hardie">
        <option value="1x4 Vinyl">
        <option value="1x6 Vinyl">
    </datalist>

    <div class="section">
        <h2>Job Details</h2>
        <label>Customer Name:</label>
        <input type="text" class="save-me" placeholder="Last Name, First Name" name="customer_name" id="cust_name">
        
        <div class="row">
            <div class="col">
                <label>PO #:</label>
                <input type="text" class="save-me" name="po_number" id="po_num">
            </div>
            <div class="col">
                <label>Date:</label>
                <input type="date" class="save-me" id="dateField" name="measure_date">
            </div>
        </div>
        
        <label>Measure Tech:</label>
        <select class="save-me" id="techSelect" name="measure_tech">
            <option value="" disabled selected>Select Tech...</option>
            <option value="Adem Atis">Adem Atis</option>
            <option value="John Suttin">John Suttin</option>
            <option value="Steven Chandler">Steven Chandler</option>
            <option value="Isaiah Stratton">Isaiah Stratton</option>
            <option value="Paz Galambos">Paz Galambos</option>
            <option value="Alan Lloyd">Alan Lloyd</option>
        </select>
    </div>

    <div id="windows-container" class="section">
        </div>
</div>

<div class="btn-group">
    <button type="button" class="btn-add" onclick="addWindow()">+ New</button>
    <button type="button" class="btn-dup" onclick="duplicateLast()">+ Copy</button>
    <button type="button" class="btn-print" id="pdfBtn" onclick="downloadPDF()">Save PDF</button>
    <button type="button" class="btn-reset" onclick="startNewJob()">Start Job</button>
</div>

<script>
    const container = document.getElementById('windows-container');
    const saveMsg = document.getElementById('saveMsg');
    let saveTimeout;

    // --- APP INIT ---
    window.onload = function() { loadData(); };

    // --- ADD WINDOW FUNCTION ---
    function addWindow(data = null) {
        const currentCount = container.querySelectorAll('.window-card').length + 1;
        
        const vals = data || {
            loc: '', floor: '1st', fins: '', w: '', h: '', jamb: '', trim: '', 
            l_sw: false, l_gt: false, l_sr: false, l_rf: false, notes: '',
            p1: null, p2: null, p3: null // Added Photo Placeholders
        };

        const cardId = 'card_' + Date.now() + Math.floor(Math.random() * 1000);

        const html = `
        <div class="window-card" id="${cardId}">
            <div class="window-header">
                <div class="window-number">#<span class="count-display">${currentCount}</span></div>
                <button class="btn-delete" onclick="deleteWindow('${cardId}')">Ã—</button>
            </div>
            
            <label>Location Name:</label>
            <input type="text" class="loc-name save-me-dynamic" placeholder="e.g. Master Bed" value="${vals.loc}">
            <div class="row">
                <div class="col"><label>Floor:</label><select class="save-me-dynamic" onchange="triggerSave()">
                    <option ${vals.floor === '1st' ? 'selected' : ''}>1st</option>
                    <option ${vals.floor === '2nd' ? 'selected' : ''}>2nd</option>
                    <option ${vals.floor === '3rd' ? 'selected' : ''}>3rd</option>
                    <option ${vals.floor === 'Bsmt' ? 'selected' : ''}>Bsmt</option>
                </select></div>
                <div class="col"><label>Fins?</label><select class="save-me-dynamic" onchange="triggerSave()">
                    <option value="" ${vals.fins === '' ? 'selected' : ''}></option>
                    <option ${vals.fins === 'Yes' ? 'selected' : ''}>Yes</option>
                    <option ${vals.fins === 'No' ? 'selected' : ''}>No</option>
                </select></div>
            </div>
            <div class="row">
                <div class="col"><label>Width:</label><input type="number" class="save-me-dynamic" inputmode="decimal" placeholder="0.0" value="${vals.w}"></div>
                <div class="col"><label>Height:</label><input type="number" class="save-me-dynamic" inputmode="decimal" placeholder="0.0" value="${vals.h}"></div>
            </div>
            <label>Jamb Depth:</label><input type="text" class="save-me-dynamic" list="jamb-sizes" placeholder="Select or Type..." value="${vals.jamb}">
            <label>Ext. Trim:</label><input type="text" class="save-me-dynamic" list="trim-types" placeholder="Select or Type..." value="${vals.trim}">
            <label>Window Labor:</label>
            <div class="labor-options">
                <label><input type="checkbox" class="save-me-dynamic" ${vals.l_sw ? 'checked' : ''}> Cut back sheet rock/wood</label>
                <label><input type="checkbox" class="save-me-dynamic" ${vals.l_gt ? 'checked' : ''}> Cut back Granit/Tile</label>
                <label><input type="checkbox" class="save-me-dynamic" ${vals.l_sr ? 'checked' : ''}> Stucco Removal</label>
                <label><input type="checkbox" class="save-me-dynamic" ${vals.l_rf ? 'checked' : ''}> Re-Trim/Flashing</label>
            </div>
            <label>Notes:</label><textarea class="save-me-dynamic">${vals.notes}</textarea>
            
            <label class="photo-label">Photos (Tap box to add):</label>
            <div class="photo-grid">
                ${renderPhotoBox(1, vals.p1)}
                ${renderPhotoBox(2, vals.p2)}
                ${renderPhotoBox(3, vals.p3)}
            </div>
        </div>`;
        
        container.insertAdjacentHTML('beforeend', html);
        
        const newCard = document.getElementById(cardId);
        newCard.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('input', triggerSave);
            input.addEventListener('change', triggerSave);
        });

        if (!data) { 
            setTimeout(() => newCard.scrollIntoView({ behavior: "smooth", block: "center" }), 150); 
            triggerSave(); 
        }
    }

    function renderPhotoBox(num, dataUrl) {
        const hasImg = dataUrl ? 'has-image' : '';
        const imgSrc = dataUrl || '';
        const displayImg = dataUrl ? 'block' : 'none';
        const displayPlace = dataUrl ? 'none' : 'block';
        
        return `
        <div class="photo-box ${hasImg}" onclick="triggerFile(this)">
            <div class="photo-placeholder" style="display:${displayPlace}">ðŸ“·<br>Photo ${num}</div>
            <div class="photo-spinner"></div>
            <img class="photo-preview" src="${imgSrc}" style="display:${displayImg}">
            <input type="file" accept="image/*" capture="environment" onchange="processImage(this)">
        </div>`;
    }

    // --- DELETE FUNCTION ---
    function deleteWindow(id) {
        if(confirm('Delete this window?')) {
            document.getElementById(id).remove();
            renumberWindows();
            triggerSave();
        }
    }

    function renumberWindows() {
        const cards = document.querySelectorAll('.window-card');
        cards.forEach((card, index) => {
            card.querySelector('.count-display').innerText = index + 1;
        });
    }

    // --- DUPLICATION LOGIC ---
    function duplicateLast() {
        const allCards = document.querySelectorAll('.window-card');
        if (allCards.length === 0) { addWindow(); return; }
        const lastCard = allCards[allCards.length - 1];
        const inputs = lastCard.querySelectorAll('.save-me-dynamic');
        
        // Exclude dimensions/notes, copy rest
        const data = {
            loc: '', floor: inputs[1].value, fins: inputs[2].value, w: '', h: '', jamb: inputs[5].value, trim: inputs[6].value,
            l_sw: inputs[7].checked, l_gt: inputs[8].checked, l_sr: inputs[9].checked, l_rf: inputs[10].checked, notes: '',
            p1: null, p2: null, p3: null // Do not copy photos
        };
        addWindow(data);
        
        setTimeout(() => {
            const all = document.querySelectorAll('.window-card');
            const target = all[all.length-1].querySelector('.loc-name');
            if(target) target.focus();
        }, 200);
    }

    // --- SAVE SYSTEM ---
    function triggerSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(performSave, 1000); // Slower save to prevent lag
    }

    function performSave() {
        try {
            const globalData = { cust: document.getElementById('cust_name').value, po: document.getElementById('po_num').value, date: document.getElementById('dateField').value, tech: document.getElementById('techSelect').value };
            const windowData = [];
            document.querySelectorAll('.window-card').forEach(card => {
                const inputs = card.querySelectorAll('.save-me-dynamic');
                const imgs = card.querySelectorAll('.photo-preview');
                windowData.push({
                    loc: inputs[0].value, floor: inputs[1].value, fins: inputs[2].value, w: inputs[3].value, h: inputs[4].value, jamb: inputs[5].value, trim: inputs[6].value,
                    l_sw: inputs[7].checked, l_gt: inputs[8].checked, l_sr: inputs[9].checked, l_rf: inputs[10].checked, notes: inputs[11].value,
                    p1: imgs[0].src.startsWith('data:') ? imgs[0].src : null,
                    p2: imgs[1].src.startsWith('data:') ? imgs[1].src : null,
                    p3: imgs[2].src.startsWith('data:') ? imgs[2].src : null
                });
            });
            localStorage.setItem('simplyDoorsMeasureData', JSON.stringify({ global: globalData, windows: windowData }));
            saveMsg.style.background = 'rgba(40, 167, 69, 0.9)';
            saveMsg.innerText = "Saved";
            saveMsg.style.opacity = '1'; 
            setTimeout(() => saveMsg.style.opacity = '0', 1500);
        } catch (e) {
            console.error("Storage Full");
            saveMsg.style.background = 'rgba(220, 53, 69, 0.9)';
            saveMsg.innerText = "Storage Full";
            saveMsg.style.opacity = '1';
        }
    }

    function loadData() {
        const savedJSON = localStorage.getItem('simplyDoorsMeasureData');
        if (!savedJSON) { document.getElementById('dateField').valueAsDate = new Date(); addWindow(); return; }
        
        try {
            const data = JSON.parse(savedJSON);
            document.getElementById('cust_name').value = data.global.cust || '';
            document.getElementById('po_num').value = data.global.po || '';
            document.getElementById('dateField').value = data.global.date || '';
            document.getElementById('techSelect').value = data.global.tech || '';
            
            container.innerHTML = ''; 
            if (data.windows && data.windows.length > 0) data.windows.forEach(winData => addWindow(winData)); 
            else addWindow();
        } catch (e) {
            addWindow();
        }
    }

    // --- PDF GENERATION ---
    function downloadPDF() {
        document.body.classList.add('printing-mode');
        document.querySelectorAll('textarea, input').forEach(el => {
            if(el.type !== 'checkbox' && el.type !== 'file') el.setAttribute('value', el.value);
            if(el.tagName === 'TEXTAREA') el.innerHTML = el.value;
            if(el.type === 'checkbox' && el.checked) el.setAttribute('checked', 'checked');
        });

        let name = document.getElementById('cust_name').value.trim();
        if(!name) name = "Measure";
        name = "SimplyDoors_" + name.replace(/[^a-z0-9]/gi, '_');

        const btn = document.getElementById('pdfBtn');
        const originalText = btn.innerText;
        btn.innerText = "â³ Making PDF...";
        
        const element = document.getElementById('pdf-content');
        const opt = {
            margin:       [5, 5, 5, 5],
            filename:     name + '.pdf',
            image:        { type: 'jpeg', quality: 0.75 }, // Lower quality for stability
            html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(function(){
            btn.innerText = originalText;
            document.body.classList.remove('printing-mode');
        }).catch(function(err) {
            alert("PDF Error. Try reducing photos.");
            document.body.classList.remove('printing-mode');
            btn.innerText = originalText;
        });
    }

    function startNewJob() {
        if(confirm("âš ï¸ Start New Job?\n\nThis will ERASE all current data.")) {
            localStorage.removeItem('simplyDoorsMeasureData'); 
            location.reload();
        }
    }

    document.querySelectorAll('.save-me').forEach(el => {
        el.addEventListener('input', triggerSave);
    });

    // --- PHOTO COMPRESSION SYSTEM ---
    function triggerFile(box) { const input = box.querySelector('input[type="file"]'); if (input) input.click(); }
    
    function processImage(input) { 
        const file = input.files[0]; 
        if (!file) return;
        
        const box = input.parentElement;
        const img = box.querySelector('.photo-preview');
        const placeholder = box.querySelector('.photo-placeholder');
        const spinner = box.querySelector('.photo-spinner');

        // UI State: Loading
        placeholder.style.display = 'none';
        spinner.style.display = 'block';

        const reader = new FileReader();
        reader.onload = function(e) {
            const tempImg = new Image();
            tempImg.src = e.target.result;
            tempImg.onload = function() {
                // Resize Logic
                const maxWidth = 800; // Reduce size for performance
                const scaleSize = maxWidth / tempImg.width;
                const newWidth = maxWidth;
                const newHeight = tempImg.height * scaleSize;

                const canvas = document.createElement('canvas');
                canvas.width = newWidth;
                canvas.height = newHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(tempImg, 0, 0, newWidth, newHeight);

                // Compress to JPEG 0.7
                const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                
                // UI State: Done
                img.src = compressedDataUrl;
                img.style.display = 'block';
                spinner.style.display = 'none';
                box.classList.add('has-image');
                
                triggerSave(); // Save to storage
            }
        };
        reader.readAsDataURL(file);
    }
</script>

</body>
</html>